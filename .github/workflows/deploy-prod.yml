name: Deploy Streamlit PROD

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      # 1) Checkout do código
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) Debug (opcional, mas recomendo manter por enquanto)
      - name: Show current directory (debug)
        shell: powershell
        run: |
          pwd
          dir

      # 3) Criar .env SEM BOM (Windows-safe)
      - name: Create .env file
        shell: powershell
        run: |
          @"
            DB_HOST=${{ secrets.DB_HOST }}
            DB_PORT=${{ secrets.DB_PORT }}
            DB_USER=${{ secrets.DB_USER }}
            DB_PASS=${{ secrets.DB_PASS }}
            API_KEY=${{ secrets.API_KEY }}
          "@ | Out-File -FilePath .env -Encoding ascii -Force

      # 4) Derrubar containers antigos
      - name: Docker down
        shell: powershell
        run: |
          docker compose -f docker-compose.prod.yml down --volumes --remove-orphans

      # 5) Build da imagem
      - name: Docker build
        shell: powershell
        run: |
          docker compose -f docker-compose.prod.yml build --no-cache

      # 6) Subir containers
      - name: Docker up
        shell: powershell
        run: |
          docker compose -f docker-compose.prod.yml up -d

      # 7) Verificação final
      - name: Docker ps
        shell: powershell
        run: |
          docker ps
